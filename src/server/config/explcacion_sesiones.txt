ğŸ“Œ ExplicaciÃ³n Completa del Sistema de Inicio de SesiÃ³n en Next.js con Cookies y Contexto
Tu sistema de inicio de sesiÃ³n funciona de la siguiente manera:

El usuario inicia sesiÃ³n en LoginPage.tsx, enviando credenciales al backend.
El backend valida las credenciales, genera un JWT (Token de SesiÃ³n) y lo guarda en cookies HTTP-only.
El frontend guarda los datos del usuario en el contexto global de AuthContext.tsx.
Los componentes protegidos dependen de useAuth() y solo se muestran si el usuario estÃ¡ autenticado.
Al cerrar sesiÃ³n, el backend elimina la cookie y el frontend actualiza el contexto.


ğŸ—‚ï¸ Archivos involucrados
Archivo	FunciÃ³n
LoginPage.tsx	                Envia credenciales al backend, guarda el usuario en el contexto y redirige.
AuthContext.tsx	                Maneja el estado global del usuario (user) y gestiona logout().
authRoutes.js                   (backend)	Define las rutas /login, /logout y /profile.
authController.js               (backend)	Valida credenciales, genera el token y maneja cookies.
authMiddleware.js               (backend)	Protege rutas verificando la validez del token.
server.js                       (backend)	Configura el servidor Express y usa las rutas de autenticaciÃ³n

ğŸ”„ Paso a Paso: Flujo del Login
1ï¸âƒ£ El usuario ingresa credenciales en LoginPage.tsx
Cuando el usuario llena el formulario y hace clic en "Iniciar sesiÃ³n", se ejecuta:

tsx
Copiar
Editar
const handleLogin = async (e: React.FormEvent) => {
  e.preventDefault();
  
  try {
    const response = await Axios.post(
      "http://localhost:3001/api/auth/login",
      { user_handle: username, password, rememberMe },
      { withCredentials: true } // ğŸ”¥ Importante para incluir cookies HTTP-only
    );
ğŸ“Œ QuÃ© hace este cÃ³digo:
âœ… Envia los datos de username y password al backend (/api/auth/login).
âœ… Usa { withCredentials: true } para que el navegador reciba y guarde la cookie con el token JWT.

2ï¸âƒ£ El backend valida credenciales en authController.js
Cuando el backend recibe la solicitud, ejecuta:

js
Copiar
Editar
const loginUser = async (req, res) => {
    const { user_handle, password } = req.body;

    try {
        const query = `SELECT * FROM users WHERE user_handle = @user_handle`;
        const result = await executeQuery(query, [
            { name: "user_handle", type: db.NVarChar, value: user_handle },
        ]);

        if (result.recordset.length === 0) {
            return res.status(401).send("Usuario no encontrado");
        }

        const user = result.recordset[0];
        const validPassword = await bcrypt.compare(password, user.password);

        if (!validPassword) {
            return res.status(401).send("ContraseÃ±a incorrecta");
        }

        const token = jwt.sign(
            { id: user.user_id, user_handle: user.user_handle },
            SECRET_KEY,
            { expiresIn: "1h" }
        );

        res.cookie("token", token, {
            httpOnly: true, 
            secure: false, 
            sameSite: "lax",
        });

        res.send("Login exitoso");
    } catch (error) {
        console.error("âŒ Error en el login:", error);
        res.status(500).send("Error en el servidor");
    }
};
ğŸ“Œ QuÃ© hace este cÃ³digo:
âœ… Busca el usuario en la base de datos con el user_handle.
âœ… Verifica la contraseÃ±a con bcrypt.compare().
âœ… Si es correcta, genera un token JWT con jwt.sign().
âœ… Guarda el token en una cookie HTTP-only para que no sea accesible desde JavaScript.
âœ… Responde con "Login exitoso".

3ï¸âƒ£ El frontend obtiene los datos del usuario en AuthContext.tsx
DespuÃ©s del login, el frontend llama a /api/auth/me para obtener los datos del usuario:

tsx
Copiar
Editar
useEffect(() => {
  fetch("/api/auth/me", { credentials: "include" })
    .then((res) => res.json())
    .then((data) => {
      if (data.authenticated) {
        setUser(data.user);
      }
    })
    .catch(() => setUser(null))
    .finally(() => setLoading(false));
}, []);
ğŸ“Œ QuÃ© hace este cÃ³digo:
âœ… EnvÃ­a la cookie con el token al backend (credentials: "include").
âœ… Si el usuario estÃ¡ autenticado, guarda sus datos en setUser(user).
âœ… Si la sesiÃ³n no es vÃ¡lida, borra setUser(null) y desloguea al usuario.

4ï¸âƒ£ /api/auth/me devuelve los datos del usuario en authRoutes.js
Esta ruta obtiene la cookie y devuelve la informaciÃ³n del usuario autenticado:

js
Copiar
Editar
router.get("/profile", authMiddleware, getUserProfile);
ğŸ“Œ QuÃ© hace este cÃ³digo:
âœ… Verifica el token con authMiddleware.js antes de acceder a los datos del usuario.
âœ… Devuelve la informaciÃ³n del usuario si la autenticaciÃ³n es correcta.

5ï¸âƒ£ Solo se muestran las cards si el usuario estÃ¡ autenticado
tsx
Copiar
Editar
const { user } = useAuth();

if (!user) return null; // ğŸ”¥ Oculta el componente si el usuario NO estÃ¡ logueado
ğŸ“Œ QuÃ© hace este cÃ³digo:
âœ… Si user es null, el botÃ³n de cerrar sesiÃ³n y las cards no se renderizan.
âœ… Si user tiene datos, las cards aparecen.

ğŸ”„ Flujo del Logout
Cuando el usuario presiona "Cerrar SesiÃ³n", el frontend ejecuta:

tsx
Copiar
Editar
const logout = async () => {
  await fetch("http://localhost:3001/api/auth/logout", {
    method: "POST",
    credentials: "include",
  });

  setUser(null); // ğŸ”¥ Borra el usuario del contexto
  router.push("/pages/login"); // ğŸ”¥ Redirige al login tras cerrar sesiÃ³n
};
ğŸ“Œ QuÃ© hace este cÃ³digo:
âœ… Borra la cookie del navegador (/logout) en el backend.
âœ… Borra los datos del usuario de setUser(null) en el frontend.
âœ… Redirige al login (/pages/login).

Backend en authController.js
js
Copiar
Editar
const logout = (req, res) => {
    res.clearCookie("token", { path: "/" });
    res.send("Logout exitoso");
};
ğŸ“Œ QuÃ© hace este cÃ³digo:
âœ… Borra la cookie token del usuario.
âœ… Devuelve "Logout exitoso".

ğŸš€ Resumen
âœ… Inicio de sesiÃ³n

Usuario ingresa credenciales en LoginPage.tsx.
Se envÃ­an credenciales a authRoutes.js (/login).
Si son correctas, el backend genera un JWT y lo guarda en cookies.
El frontend obtiene el perfil del usuario (/api/auth/me) y lo guarda en AuthContext.
Las cards protegidas ahora se muestran.
âœ… Cierre de sesiÃ³n

El usuario presiona "Cerrar SesiÃ³n" (logout).
Se elimina la cookie en el backend (/logout).
Se borra el usuario de AuthContext.
Las cards protegidas desaparecen y se redirige al login.
ğŸ”¥ ConclusiÃ³n
ğŸš€ El sistema de autenticaciÃ³n estÃ¡ bien implementado, basado en cookies HTTP-only y con estado global en AuthContext.tsx.
ğŸ“Œ Los componentes protegidos solo se renderizan si user tiene datos.
âœ… Logout limpia el contexto y las cookies, asegurando que el usuario realmente se desloguea.

Si tienes dudas o quieres mejorar algo, dime y lo vemos. Â¡Buen trabajo! ğŸ”¥ğŸ’ªğŸš€
